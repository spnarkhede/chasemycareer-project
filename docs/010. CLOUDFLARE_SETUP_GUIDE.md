# Cloudflare Integration Setup Guide

This guide will walk you through setting up Cloudflare integration with your Supabase-powered ChaseMyCareer application.

## ğŸ“‹ Prerequisites

- Existing ChaseMyCareer application with Supabase
- Cloudflare account (free tier is sufficient to start)
- Node.js and npm installed
- Git repository (for Cloudflare Pages deployment)

## ğŸ¯ What You'll Get

- âœ… **Faster Performance**: Global CDN for static assets
- âœ… **Edge Caching**: Reduced API calls to Supabase
- âœ… **Image Optimization**: Automatic image resizing and format conversion
- âœ… **Better Security**: DDoS protection and rate limiting
- âœ… **Lower Costs**: Reduced Supabase bandwidth usage
- âœ… **Keep Everything**: All Supabase features remain intact

## ğŸ“Š Estimated Time

- **Quick Start** (Pages hosting only): 30 minutes
- **Full Integration** (with Workers and caching): 2-3 hours

---

## Phase 1: Cloudflare Account Setup (15 minutes)

### Step 1: Create Cloudflare Account

1. Go to [cloudflare.com](https://cloudflare.com)
2. Click "Sign Up" and create a free account
3. Verify your email address

### Step 2: Get Account ID

1. Log in to Cloudflare Dashboard
2. Click on your profile icon (top right)
3. Go to "My Profile" â†’ "API Tokens"
4. Copy your **Account ID** (you'll need this later)

### Step 3: Create API Token

1. In the API Tokens page, click "Create Token"
2. Use the "Edit Cloudflare Workers" template
3. Add these permissions:
   - **Account** â†’ **Workers KV Storage** â†’ **Edit**
   - **Account** â†’ **Workers Scripts** â†’ **Edit**
   - **Zone** â†’ **Cache Purge** â†’ **Purge**
   - **Account** â†’ **Analytics** â†’ **Read**
4. Click "Continue to summary"
5. Click "Create Token"
6. **Copy the token** (you won't see it again!)

### Step 4: Add Domain (Optional)

If you have a custom domain:
1. Click "Add a Site" in Cloudflare Dashboard
2. Enter your domain name
3. Follow the instructions to change your nameservers
4. Wait for DNS propagation (can take up to 24 hours)

---

## Phase 2: Environment Configuration (10 minutes)

### Step 1: Update Environment Variables

Copy `.env.template` to `.env.local`:

```bash
cp .env.template .env.local
```

### Step 2: Add Cloudflare Configuration

Edit `.env.local` and add:

```env
# Cloudflare Configuration
VITE_CLOUDFLARE_ACCOUNT_ID=your_account_id_from_step_2
VITE_CLOUDFLARE_API_TOKEN=your_api_token_from_step_3
VITE_CLOUDFLARE_ZONE_ID=your_zone_id_if_you_have_domain
VITE_CLOUDFLARE_WORKER_URL=https://chasemycareer-worker.your-subdomain.workers.dev
```

**Note**: Leave `VITE_CLOUDFLARE_WORKER_URL` empty for now. We'll update it after deploying the Worker.

### Step 3: Keep Existing Supabase Configuration

Make sure these are still present:

```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_GOOGLE_CLIENT_ID=your_google_client_id
```

---

## Phase 3: Deploy to Cloudflare Pages (30 minutes)

### Step 1: Install Wrangler CLI

```bash
npm install -g wrangler
```

### Step 2: Login to Cloudflare

```bash
wrangler login
```

This will open a browser window for authentication.

### Step 3: Build Your Application

```bash
npm run build
```

### Step 4: Deploy to Pages (Option A: CLI)

```bash
wrangler pages deploy dist --project-name=chasemycareer
```

Follow the prompts to create a new project.

### Step 4: Deploy to Pages (Option B: GitHub - Recommended)

1. Push your code to GitHub (if not already done)
2. Go to Cloudflare Dashboard â†’ Pages
3. Click "Create a project"
4. Click "Connect to Git"
5. Select your repository
6. Configure build settings:
   - **Build command**: `npm run build`
   - **Build output directory**: `dist`
   - **Root directory**: `/`
7. Add environment variables:
   - Click "Environment variables"
   - Add all `VITE_*` variables from your `.env.local`
8. Click "Save and Deploy"

### Step 5: Get Your Pages URL

After deployment completes, you'll get a URL like:
```
https://chasemycareer.pages.dev
```

Your application is now hosted on Cloudflare's global CDN! ğŸ‰

---

## Phase 4: Deploy Cloudflare Worker (Optional - 45 minutes)

This step adds edge caching and image optimization.

### Step 1: Create KV Namespace

```bash
wrangler kv:namespace create "CACHE_KV"
```

Copy the `id` from the output.

### Step 2: Create Preview KV Namespace

```bash
wrangler kv:namespace create "CACHE_KV" --preview
```

Copy the `preview_id` from the output.

### Step 3: Update wrangler.toml

Edit `wrangler.toml` and update:

```toml
account_id = "your_account_id"

[[kv_namespaces]]
binding = "CACHE_KV"
id = "your_kv_id_from_step_1"
preview_id = "your_preview_kv_id_from_step_2"
```

### Step 4: Create R2 Bucket (Optional)

If you want to use R2 for storage:

```bash
wrangler r2 bucket create chasemycareer-storage
```

### Step 5: Deploy Worker

```bash
wrangler deploy
```

### Step 6: Get Worker URL

After deployment, you'll see:
```
Published chasemycareer-worker
  https://chasemycareer-worker.your-subdomain.workers.dev
```

### Step 7: Update Environment Variables

Update `.env.local` with your Worker URL:

```env
VITE_CLOUDFLARE_WORKER_URL=https://chasemycareer-worker.your-subdomain.workers.dev
```

### Step 8: Rebuild and Redeploy

```bash
npm run build
wrangler pages deploy dist --project-name=chasemycareer
```

Or push to GitHub if using automatic deployment.

---

## Phase 5: Test Integration (15 minutes)

### Step 1: Test Health Check

Open your browser and visit:
```
https://your-worker-url.workers.dev/health
```

You should see:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Step 2: Test Your Application

1. Visit your Cloudflare Pages URL
2. Log in to your application
3. Open browser DevTools â†’ Network tab
4. Navigate through the app
5. Look for:
   - Fast page loads
   - Cached responses (check `CF-Cache-Status` header)
   - Optimized images

### Step 3: Check Cache Performance

In your browser console:

```javascript
// This should be available in your app
const health = await fetch('https://your-worker-url.workers.dev/health');
console.log(await health.json());
```

### Step 4: Test Image Optimization

Try accessing an image through the Worker:

```
https://your-worker-url.workers.dev/image?url=YOUR_SUPABASE_IMAGE_URL&width=300&format=webp
```

---

## Phase 6: Update Your Application Code (30 minutes)

### Step 1: Use Hybrid Manager in Your API Calls

Update `src/db/api.ts`:

```typescript
import { hybridManager } from '@/services/hybrid-manager';
import { supabase } from './supabase';

export const api = {
  // Example: Fetch with caching
  async getDailyTasks(userId: string) {
    return hybridManager.fetchWithCache(
      `tasks-${userId}`,
      async () => {
        const { data, error } = await supabase
          .from('daily_tasks')
          .select('*')
          .eq('user_id', userId)
          .order('day_number');

        if (error) throw error;
        return data;
      },
      { ttl: 300 } // Cache for 5 minutes
    );
  },

  // Example: Update with cache invalidation
  async updateTask(taskId: string, updates: any, userId: string) {
    const { data, error } = await supabase
      .from('daily_tasks')
      .update(updates)
      .eq('id', taskId)
      .select()
      .single();

    if (error) throw error;

    // Invalidate cache
    await hybridManager.invalidateCache([`tasks-${userId}`]);

    return data;
  },
};
```

### Step 2: Use Optimized Images

Update image components to use optimized URLs:

```typescript
import { hybridManager } from '@/services/hybrid-manager';

function UserAvatar({ imageUrl }: { imageUrl: string }) {
  const optimizedUrl = hybridManager.getOptimizedImageUrl(imageUrl, {
    width: 150,
    height: 150,
    fit: 'cover',
    format: 'auto',
  });

  return <img src={optimizedUrl} alt="Avatar" />;
}
```

### Step 3: Use Hybrid Upload

Update file upload code:

```typescript
import { hybridManager } from '@/services/hybrid-manager';

async function handleAvatarUpload(file: File) {
  const result = await hybridManager.uploadImage(file, 'avatars');
  
  // result contains:
  // - original: Supabase URL
  // - optimized: Cloudflare optimized URL
  // - thumbnail: 150x150 thumbnail
  // - responsive: { small, medium, large }
  
  // Save to database
  await supabase
    .from('profiles')
    .update({ avatar_url: result.optimized })
    .eq('id', userId);
}
```

---

## ğŸ¯ Quick Start (Minimal Setup)

If you just want to get started quickly with Pages hosting:

```bash
# 1. Install Wrangler
npm install -g wrangler

# 2. Login
wrangler login

# 3. Build
npm run build

# 4. Deploy
wrangler pages deploy dist --project-name=chasemycareer
```

Done! Your app is now on Cloudflare's CDN.

You can add Workers and caching later when needed.

---

## ğŸ” Verification Checklist

After setup, verify:

- [ ] Application loads from Cloudflare Pages URL
- [ ] All pages and routes work correctly
- [ ] Login/authentication works
- [ ] Images load properly
- [ ] Supabase data fetches correctly
- [ ] Worker health check responds (if deployed)
- [ ] Cache headers present in responses
- [ ] No console errors

---

## ğŸ“Š Monitoring

### Cloudflare Analytics

1. Go to Cloudflare Dashboard â†’ Analytics
2. View:
   - Page views and visitors
   - Bandwidth usage
   - Cache hit rate
   - Performance metrics

### Worker Logs

View Worker logs:

```bash
wrangler tail
```

### Cache Performance

Check cache hit rate in browser DevTools:
- Look for `CF-Cache-Status` header
- Values: `HIT`, `MISS`, `EXPIRED`, `BYPASS`

---

## ğŸ› Troubleshooting

### Issue: Worker not accessible

**Solution**: Check wrangler.toml configuration and redeploy:
```bash
wrangler deploy
```

### Issue: Images not optimizing

**Solution**: Verify Worker URL in environment variables and rebuild:
```bash
npm run build
wrangler pages deploy dist
```

### Issue: Cache not working

**Solution**: Check KV namespace is created and bound correctly in wrangler.toml

### Issue: CORS errors

**Solution**: Worker includes CORS headers. If issues persist, check Worker logs:
```bash
wrangler tail
```

### Issue: Environment variables not working

**Solution**: 
- For local development: Check `.env.local`
- For Pages: Add variables in Cloudflare Dashboard â†’ Pages â†’ Settings â†’ Environment variables
- Rebuild after changes

---

## ğŸ’° Cost Estimation

### Free Tier Limits

**Cloudflare Pages:**
- âœ… Unlimited requests
- âœ… 500 builds/month
- âœ… Unlimited bandwidth

**Cloudflare Workers:**
- âœ… 100,000 requests/day
- âœ… 10ms CPU time per request

**Workers KV:**
- âœ… 100,000 reads/day
- âœ… 1,000 writes/day
- âœ… 1GB storage

**Most applications stay within free tier!**

### Paid Plans (if needed)

- **Workers**: $5/month for 10 million requests
- **KV**: $0.50/million reads after free tier
- **R2**: $0.015/GB storage

---

## ğŸš€ Next Steps

After basic setup:

1. **Monitor Performance**: Check analytics and cache hit rates
2. **Optimize Caching**: Adjust TTL values based on data update frequency
3. **Add More Endpoints**: Gradually add caching to more API calls
4. **Custom Domain**: Set up your own domain in Cloudflare
5. **Advanced Features**: Explore rate limiting, bot protection, etc.

---

## ğŸ“š Additional Resources

- [Cloudflare Pages Docs](https://developers.cloudflare.com/pages/)
- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Workers KV Docs](https://developers.cloudflare.com/workers/runtime-apis/kv/)
- [Wrangler CLI Docs](https://developers.cloudflare.com/workers/wrangler/)

---

## ğŸ†˜ Need Help?

If you encounter issues:

1. Check the troubleshooting section above
2. Review Cloudflare documentation
3. Check Worker logs: `wrangler tail`
4. Verify environment variables
5. Test with Worker health endpoint

---

**Congratulations!** ğŸ‰

You now have a hybrid architecture with:
- âœ… Supabase for database, auth, and storage
- âœ… Cloudflare for CDN, caching, and optimization
- âœ… Best of both platforms
- âœ… Improved performance and lower costs
