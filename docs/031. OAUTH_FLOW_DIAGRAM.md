# Google OAuth with PKCE - Flow Diagram

## Complete Authentication Flow

```
┌─────────────┐                                    ┌──────────────┐
│   Browser   │                                    │    Google    │
│  (Client)   │                                    │    OAuth     │
└──────┬──────┘                                    └──────┬───────┘
       │                                                  │
       │ 1. User clicks "Connect Calendar"               │
       │                                                  │
       │ 2. Generate PKCE verifier & challenge           │
       │    - verifier: random 128 chars                 │
       │    - challenge: SHA256(verifier)                │
       │    - Store verifier in sessionStorage           │
       │                                                  │
       │ 3. Redirect to Google OAuth                     │
       │    with code_challenge & state                  │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │                                                  │ 4. User authenticates
       │                                                  │    & grants permissions
       │                                                  │
       │ 5. Redirect back with code & state              │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │ 6. Validate state parameter                     │
       │    (CSRF protection)                             │
       │                                                  │
       │                                                  │
       │                                                  │
       │                                                  │
┌──────▼──────┐                                    ┌──────▼───────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │     Edge     │
└──────┬──────┘                                    │   Function   │
       │                                           └──────┬───────┘
       │                                                  │
       │ 7. Send code & verifier to Edge Function        │
       │    POST /functions/v1/exchange-google-token     │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │                                                  │ 8. Exchange with Google
       │                                                  │    - Send code, verifier
       │                                                  │    - Include client_secret
       │                                                  │    - Google validates PKCE
       │                                                  │
       │                                                  │ 9. Receive tokens
       │                                                  │    - access_token
       │                                                  │    - refresh_token
       │                                                  │    - expires_in
       │                                                  │
       │ 10. Return tokens to client                     │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │                                                  │
       │                                                  │
┌──────▼──────┐                                    ┌──────▼───────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │   Database   │
└──────┬──────┘                                    └──────┬───────┘
       │                                                  │
       │ 11. Store tokens in database                    │
       │     INSERT INTO oauth_tokens                    │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │                                                  │ 12. RLS policies
       │                                                  │     enforce security
       │                                                  │
       │ 13. Tokens stored securely                      │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │ 14. Clear session storage                       │
       │     (remove verifier & state)                   │
       │                                                  │
       │ 15. Redirect to dashboard                       │
       │                                                  │
       ▼                                                  ▼
```

## Token Refresh Flow

```
┌─────────────┐                                    ┌──────────────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │   Database   │
└──────┬──────┘                                    └──────┬───────┘
       │                                                  │
       │ 1. Request calendar data                        │
       │                                                  │
       │ 2. Check token expiration                       │
       │    SELECT * FROM oauth_tokens                   │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │ 3. Token expired!                               │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │                                                  │
┌──────▼──────┐                                    ┌──────▼───────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │     Edge     │
└──────┬──────┘                                    │   Function   │
       │                                           └──────┬───────┘
       │                                                  │
       │ 4. Call refresh function                        │
       │    POST /functions/v1/refresh-google-token      │
       │    { refresh_token }                            │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │                                                  │ 5. Request new token
       │                                                  │    from Google
       │                                                  │    - Send refresh_token
       │                                                  │    - Include client_secret
       │                                                  │
       │                                                  │ 6. Receive new
       │                                                  │    access_token
       │                                                  │
       │ 7. Return new access_token                      │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │                                                  │
┌──────▼──────┐                                    ┌──────▼───────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │   Database   │
└──────┬──────┘                                    └──────┬───────┘
       │                                                  │
       │ 8. Update token in database                     │
       │    UPDATE oauth_tokens                          │
       │    SET access_token = new_token                 │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │ 9. Token updated                                │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │ 10. Continue with calendar request              │
       │                                                  │
       ▼                                                  ▼
```

## Calendar API Call Flow

```
┌─────────────┐                                    ┌──────────────┐
│   Browser   │                                    │   Supabase   │
│  (Client)   │                                    │   Database   │
└──────┬──────┘                                    └──────┬───────┘
       │                                                  │
       │ 1. User creates calendar event                  │
       │                                                  │
       │ 2. Get valid access token                       │
       │    SELECT access_token FROM oauth_tokens        │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │ 3. Return access token                          │
       │    (auto-refresh if expired)                    │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │                                                  │
┌──────▼──────┐                                    ┌──────▼───────┐
│   Browser   │                                    │    Google    │
│  (Client)   │                                    │   Calendar   │
└──────┬──────┘                                    │     API      │
       │                                           └──────┬───────┘
       │                                                  │
       │ 4. Create event request                         │
       │    POST /calendar/v3/calendars/primary/events   │
       │    Authorization: Bearer {access_token}         │
       │    Body: { summary, start, end, ... }           │
       ├─────────────────────────────────────────────────>│
       │                                                  │
       │                                                  │ 5. Validate token
       │                                                  │    & create event
       │                                                  │
       │ 6. Return created event                         │
       │<─────────────────────────────────────────────────┤
       │                                                  │
       │ 7. Display success to user                      │
       │                                                  │
       ▼                                                  ▼
```

## Security Layers

```
┌─────────────────────────────────────────────────────────────┐
│                     Security Layers                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. PKCE (Proof Key for Code Exchange)                     │
│     ├─ Code verifier (client-side, temporary)              │
│     ├─ Code challenge (sent to Google)                     │
│     └─ Prevents authorization code interception            │
│                                                             │
│  2. State Parameter                                         │
│     ├─ Random string generated per request                 │
│     ├─ Validated on callback                               │
│     └─ Prevents CSRF attacks                               │
│                                                             │
│  3. Client Secret Protection                                │
│     ├─ Stored in Supabase Edge Functions only              │
│     ├─ Never exposed to frontend                           │
│     └─ Used for server-to-server communication             │
│                                                             │
│  4. Token Storage Security                                  │
│     ├─ Stored in Supabase database                         │
│     ├─ Row Level Security (RLS) policies                   │
│     ├─ Users can only access their own tokens              │
│     └─ Encrypted at rest                                   │
│                                                             │
│  5. Session Management                                      │
│     ├─ httpOnly cookies                                    │
│     ├─ SameSite=Lax                                        │
│     ├─ Secure flag in production                           │
│     └─ Automatic session refresh                           │
│                                                             │
│  6. Automatic Token Refresh                                 │
│     ├─ Checks expiration before API calls                  │
│     ├─ Refreshes tokens automatically                      │
│     └─ Transparent to user                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Key Components

### Frontend (Browser)
- **OAuthService**: Manages PKCE flow and token operations
- **CalendarService**: Handles Google Calendar API calls
- **Calendar Page**: UI for calendar management
- **OAuth Callback**: Processes OAuth redirect

### Backend (Supabase)
- **Edge Functions**: Secure token exchange and refresh
- **Database**: Stores tokens with RLS policies
- **Auth**: Manages user sessions

### External
- **Google OAuth**: Authenticates users
- **Google Calendar API**: Provides calendar functionality

## Data Flow Summary

1. **User Action** → Click "Connect Calendar"
2. **PKCE Generation** → Create verifier and challenge
3. **OAuth Request** → Redirect to Google with challenge
4. **User Consent** → Grant permissions at Google
5. **Callback** → Return with authorization code
6. **Token Exchange** → Edge Function exchanges code (with secret)
7. **Token Storage** → Save tokens in database
8. **API Calls** → Use tokens for calendar operations
9. **Auto Refresh** → Refresh expired tokens automatically
10. **User Experience** → Seamless calendar integration
