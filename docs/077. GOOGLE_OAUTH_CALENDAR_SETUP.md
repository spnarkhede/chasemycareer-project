# Google OAuth with PKCE and Calendar Integration Setup Guide

## Overview

This application implements a secure Google OAuth 2.0 flow with PKCE (Proof Key for Code Exchange) for enhanced security, along with Google Calendar API integration. The implementation follows security best practices by keeping client secrets server-side and using secure token storage.

## Architecture

### High-Level Flow

1. **Client Initiates OAuth Request**
   - Generates PKCE code_verifier and code_challenge
   - Redirects user to Google OAuth consent screen
   - Requests scopes: `openid`, `email`, `profile`, `calendar.events`

2. **User Authentication at Google**
   - User authenticates with Google
   - User grants requested permissions
   - Google redirects back with authorization code

3. **Backend Token Exchange**
   - Client sends authorization code and code_verifier to Edge Function
   - Edge Function exchanges code with Google (server-to-server)
   - Uses client secret (never exposed to frontend)
   - Returns access token and refresh token

4. **Secure Token Storage**
   - Tokens stored in Supabase database with RLS policies
   - Access tokens automatically refreshed when expired
   - httpOnly session cookies for authentication

## Setup Instructions

### 1. Google Cloud Console Setup

#### Create OAuth 2.0 Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable the Google Calendar API:
   - Navigate to "APIs & Services" > "Library"
   - Search for "Google Calendar API"
   - Click "Enable"

4. Create OAuth 2.0 credentials:
   - Go to "APIs & Services" > "Credentials"
   - Click "Create Credentials" > "OAuth client ID"
   - Choose "Web application"
   - Configure:
     - **Name**: Your application name
     - **Authorized JavaScript origins**: 
       - `http://localhost:5173` (development)
       - `https://yourdomain.com` (production)
     - **Authorized redirect URIs**:
       - `http://localhost:5173/auth/callback` (development)
       - `https://yourdomain.com/auth/callback` (production)
   - Click "Create"
   - Copy the **Client ID** and **Client Secret**

#### Configure OAuth Consent Screen

1. Go to "APIs & Services" > "OAuth consent screen"
2. Choose "External" (or "Internal" for Google Workspace)
3. Fill in required information:
   - App name
   - User support email
   - Developer contact information
4. Add scopes:
   - `openid`
   - `email`
   - `profile`
   - `https://www.googleapis.com/auth/calendar.events`
5. Add test users (if in testing mode)
6. Save and continue

### 2. Environment Configuration

#### Update `.env` file

```env
VITE_APP_ID=chasemycareer

# Replace with your actual Google OAuth Client ID
VITE_GOOGLE_CLIENT_ID=YOUR_CLIENT_ID_HERE.apps.googleusercontent.com

# Supabase Configuration (already configured)
VITE_SUPABASE_URL=https://itazzlbcxisavqxvkmoe.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Configure Supabase Secrets

The Google Client Secret must be stored securely in Supabase (never in frontend code):

1. Go to your Supabase project dashboard
2. Navigate to "Project Settings" > "Edge Functions" > "Secrets"
3. Add the following secrets:
   - `GOOGLE_CLIENT_ID`: Your Google OAuth Client ID
   - `GOOGLE_CLIENT_SECRET`: Your Google OAuth Client Secret

**Note**: These secrets have already been created with placeholder values. Update them with your actual credentials.

### 3. Database Schema

The OAuth tokens table has been created with the following structure:

```sql
CREATE TABLE oauth_tokens (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  provider text NOT NULL,
  access_token text NOT NULL,
  refresh_token text,
  token_type text DEFAULT 'Bearer',
  expires_at timestamptz NOT NULL,
  scopes text[],
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(user_id, provider)
);
```

Row Level Security (RLS) policies ensure users can only access their own tokens.

### 4. Edge Functions

Two Edge Functions have been deployed:

#### `exchange-google-token`
- Exchanges authorization code for access/refresh tokens
- Uses PKCE code_verifier for security
- Keeps client secret server-side
- Endpoint: `https://itazzlbcxisavqxvkmoe.supabase.co/functions/v1/exchange-google-token`

#### `refresh-google-token`
- Refreshes expired access tokens
- Uses refresh token stored in database
- Automatically called when access token expires
- Endpoint: `https://itazzlbcxisavqxvkmoe.supabase.co/functions/v1/refresh-google-token`

## Security Features

### PKCE (Proof Key for Code Exchange)

1. **Code Verifier Generation**
   - Random 128-character string
   - Stored in sessionStorage (temporary)
   - Used to verify the authorization request

2. **Code Challenge**
   - SHA-256 hash of code_verifier
   - Base64 URL-encoded
   - Sent to Google during authorization

3. **Verification**
   - Google verifies code_challenge matches code_verifier
   - Prevents authorization code interception attacks

### Token Security

- **Client Secret**: Never exposed to frontend, only used in Edge Functions
- **Access Tokens**: Stored in database with RLS policies
- **Refresh Tokens**: Encrypted and stored securely
- **Session Management**: httpOnly cookies with SameSite=Lax
- **Automatic Refresh**: Tokens refreshed before expiration

### State Parameter

- Random state parameter prevents CSRF attacks
- Validated on callback to ensure request authenticity

## Usage

### Connecting Google Calendar

1. Navigate to `/google-calendar` or click "Open Calendar" on the dashboard
2. Click "Connect Google Calendar"
3. Authenticate with Google and grant permissions
4. Redirected back to application with calendar access

### Creating Calendar Events

```typescript
import { CalendarService } from '@/services/calendar.service';

// Create an event
const event = await CalendarService.createEvent({
  summary: 'Team Meeting',
  description: 'Discuss project updates',
  start: {
    dateTime: '2025-12-15T10:00:00',
    timeZone: 'America/New_York'
  },
  end: {
    dateTime: '2025-12-15T11:00:00',
    timeZone: 'America/New_York'
  },
  location: 'Conference Room A'
});
```

### Listing Events

```typescript
// Get upcoming events (next 7 days)
const events = await CalendarService.getUpcomingEvents(7);

// Get today's events
const todayEvents = await CalendarService.getTodayEvents();

// Get events with custom date range
const events = await CalendarService.listEvents(
  50, // max results
  '2025-12-01T00:00:00Z', // start time
  '2025-12-31T23:59:59Z'  // end time
);
```

### Disconnecting Calendar

```typescript
import { OAuthService } from '@/services/oauth.service';

// Revoke access and delete tokens
await OAuthService.revokeAccess();
```

## API Reference

### OAuthService

- `initiateGoogleOAuth()`: Start OAuth flow with PKCE
- `validateCallback(state, code)`: Validate OAuth callback
- `storeTokens(...)`: Store tokens in database
- `getStoredToken()`: Retrieve valid access token
- `refreshAccessToken(refreshToken)`: Refresh expired token
- `revokeAccess()`: Disconnect and delete tokens

### CalendarService

- `listEvents(maxResults, timeMin, timeMax)`: List calendar events
- `getEvent(eventId)`: Get specific event
- `createEvent(event)`: Create new event
- `updateEvent(eventId, event)`: Update existing event
- `deleteEvent(eventId)`: Delete event
- `getUpcomingEvents(days)`: Get events for next N days
- `getTodayEvents()`: Get today's events

## Troubleshooting

### Common Issues

1. **"Missing Google OAuth credentials" error**
   - Ensure `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` are set in Supabase secrets
   - Verify secrets are correctly formatted

2. **"Invalid callback" error**
   - Check that redirect URI matches exactly in Google Console
   - Verify state parameter is being stored and validated

3. **"Token exchange failed" error**
   - Ensure authorization code hasn't expired (10 minutes)
   - Verify PKCE code_verifier is correctly stored
   - Check Edge Function logs in Supabase dashboard

4. **"No access token available" error**
   - User needs to connect Google Calendar first
   - Check if tokens are stored in database
   - Verify RLS policies allow user to read their tokens

### Testing OAuth Flow

1. Clear browser sessionStorage and cookies
2. Navigate to `/google-calendar`
3. Click "Connect Google Calendar"
4. Complete OAuth flow
5. Verify tokens are stored in `oauth_tokens` table
6. Test calendar operations

## Production Checklist

- [ ] Update Google OAuth redirect URIs with production domain
- [ ] Set production `GOOGLE_CLIENT_ID` in `.env`
- [ ] Update `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` in Supabase secrets
- [ ] Verify OAuth consent screen is configured correctly
- [ ] Test complete OAuth flow in production
- [ ] Monitor Edge Function logs for errors
- [ ] Set up token refresh monitoring
- [ ] Configure rate limiting for API calls
- [ ] Review and test RLS policies

## Additional Resources

- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google Calendar API Documentation](https://developers.google.com/calendar/api/v3/reference)
- [PKCE RFC 7636](https://tools.ietf.org/html/rfc7636)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

## Support

For issues or questions:
1. Check Supabase Edge Function logs
2. Review browser console for errors
3. Verify Google Cloud Console configuration
4. Check database for stored tokens
