# Cloudflare Integration - Quick Reference

## ðŸš€ Quick Commands

### Deploy to Cloudflare Pages
```bash
# First time setup
npm install -g wrangler
wrangler login

# Build and deploy
npm run build
wrangler pages deploy dist --project-name=chasemycareer
```

### Deploy Cloudflare Worker
```bash
# Create KV namespace
wrangler kv:namespace create "CACHE_KV"
wrangler kv:namespace create "CACHE_KV" --preview

# Deploy worker
wrangler deploy

# View logs
wrangler tail
```

## ðŸ“ Environment Variables

Add to `.env.local`:
```env
# Cloudflare
VITE_CLOUDFLARE_ACCOUNT_ID=your_account_id
VITE_CLOUDFLARE_API_TOKEN=your_api_token
VITE_CLOUDFLARE_ZONE_ID=your_zone_id
VITE_CLOUDFLARE_WORKER_URL=https://your-worker.workers.dev
```

## ðŸ’» Code Examples

### 1. Fetch with Caching
```typescript
import { hybridManager } from '@/services/hybrid-manager';

const tasks = await hybridManager.fetchWithCache(
  `tasks-${userId}`,
  async () => {
    const { data } = await supabase
      .from('daily_tasks')
      .select('*')
      .eq('user_id', userId);
    return data;
  },
  { ttl: 300 } // 5 minutes
);
```

### 2. Update with Cache Invalidation
```typescript
// Update data
const { data } = await supabase
  .from('daily_tasks')
  .update({ completed: true })
  .eq('id', taskId);

// Invalidate cache
await hybridManager.invalidateCache([`tasks-${userId}`]);
```

### 3. Upload Image with Optimization
```typescript
const result = await hybridManager.uploadImage(file, 'avatars');

// result contains:
// - original: Supabase URL
// - optimized: Cloudflare optimized URL
// - thumbnail: 150x150 thumbnail
// - responsive: { small, medium, large }
```

### 4. Get Optimized Image URL
```typescript
const optimizedUrl = hybridManager.getOptimizedImageUrl(imageUrl, {
  width: 300,
  height: 300,
  fit: 'cover',
  format: 'auto',
});
```

### 5. Track Analytics
```typescript
await hybridManager.trackAction('task_completed', {
  userId,
  taskId,
  dayNumber: 5,
});
```

## ðŸŽ¯ Cache TTL Guidelines

| Data Type | TTL | Example |
|-----------|-----|---------|
| Real-time | 60-300s | User actions, live data |
| Frequent | 300-600s | Task lists, profiles |
| Moderate | 600-1800s | Job applications |
| Rare | 1800-7200s | Templates, questions |
| Static | 7200s+ | System data |

## ðŸ”‘ Cache Key Patterns

```typescript
// User-specific
`resource-${userId}`
// Example: `tasks-abc123`, `profile-abc123`

// Specific item
`resource-${userId}-${id}`
// Example: `task-abc123-day-5`

// Global data
`resource-all`
// Example: `interview-questions-all`

// Filtered data
`resource-${userId}-${filter}`
// Example: `applications-abc123-active`
```

## ðŸ” Testing

### Test Worker Health
```bash
curl https://your-worker.workers.dev/health
```

### Test Image Optimization
```bash
curl "https://your-worker.workers.dev/image?url=IMAGE_URL&width=300&format=webp"
```

### Test Cache
```typescript
// In browser console
const health = await fetch('https://your-worker.workers.dev/health');
console.log(await health.json());
```

## ðŸ“Š Monitoring

### Check Cache Hit Rate
Look for `CF-Cache-Status` header in Network tab:
- `HIT`: Served from cache âœ…
- `MISS`: Fetched from origin
- `EXPIRED`: Cache expired
- `BYPASS`: Cache bypassed

### View Worker Logs
```bash
wrangler tail
```

### Cloudflare Analytics
Dashboard â†’ Analytics â†’ View metrics

## ðŸ› Troubleshooting

### Worker not accessible
```bash
wrangler deploy
```

### Images not optimizing
Check Worker URL in `.env.local` and rebuild:
```bash
npm run build
wrangler pages deploy dist
```

### Cache not working
Verify KV namespace in `wrangler.toml`:
```toml
[[kv_namespaces]]
binding = "CACHE_KV"
id = "your_kv_id"
```

### CORS errors
Worker includes CORS headers. Check logs:
```bash
wrangler tail
```

## ðŸ’° Free Tier Limits

- **Pages**: Unlimited requests, 500 builds/month
- **Workers**: 100,000 requests/day
- **KV**: 100,000 reads/day, 1,000 writes/day
- **R2**: 10GB storage, 1M Class A operations/month

Most apps stay within free tier!

## ðŸ“š Key Files

| File | Purpose |
|------|---------|
| `src/services/cloudflare.ts` | Cloudflare API service |
| `src/services/hybrid-manager.ts` | Integration layer |
| `src/db/api-cloudflare-examples.ts` | Usage examples |
| `workers/index.js` | Worker code |
| `wrangler.toml` | Worker configuration |
| `.env.template` | Environment variables template |

## ðŸŽ“ Learning Path

1. **Start Simple**: Deploy to Pages only
2. **Add Caching**: Deploy Worker with KV
3. **Optimize Images**: Use image optimization
4. **Track Analytics**: Add event tracking
5. **Monitor**: Check cache hit rates
6. **Optimize**: Adjust TTL values

## ðŸ”— Quick Links

- [Setup Guide](./CLOUDFLARE_SETUP_GUIDE.md) - Full setup instructions
- [Integration Plan](./CLOUDFLARE_INTEGRATION_PLAN.md) - Architecture details
- [API Examples](./src/db/api-cloudflare-examples.ts) - Code patterns

## âœ… Health Check

Run this to verify everything is working:

```typescript
import { hybridManager } from '@/services/hybrid-manager';

const health = await hybridManager.healthCheck();
console.log(health);

// Expected output:
// {
//   supabase: true,
//   cloudflare: { api: true, worker: true, configured: true },
//   overall: true
// }
```

## ðŸŽ‰ Benefits

- âœ… **50-80% faster** page loads (CDN)
- âœ… **30-50% fewer** Supabase API calls (caching)
- âœ… **60-70% smaller** image sizes (optimization)
- âœ… **99.99% uptime** (Cloudflare's network)
- âœ… **DDoS protection** (automatic)
- âœ… **Global reach** (300+ cities)

## ðŸš¦ Status Indicators

### Green (All Good)
- Pages deployed successfully
- Worker responding to health checks
- Cache hit rate > 50%
- No errors in logs

### Yellow (Needs Attention)
- Cache hit rate < 30%
- Occasional Worker errors
- High response times

### Red (Issues)
- Worker not accessible
- Frequent errors in logs
- Cache not working
- Images not optimizing

## ðŸ“ž Support

1. Check [Setup Guide](./CLOUDFLARE_SETUP_GUIDE.md)
2. Review [Troubleshooting](#-troubleshooting)
3. Check Worker logs: `wrangler tail`
4. Test health endpoint
5. Verify environment variables

---

**Remember**: Start with Pages hosting, then gradually add Workers and caching as needed!
